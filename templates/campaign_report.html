{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h1>{{ report.campaign.subject }}</h1>
    <p class="text-muted">Campaign Report ‚Ä¢ Generated: {{ report.generated_at }}</p>

    <div id="campaign-live" data-cid="{{ report.campaign.id }}" class="mb-3">
        <div class="small text-muted">Live Status: <span class="live-status">{{ report.campaign.status }}</span></div>
        <div class="small">Sent: <span class="live-sent">{{ report.sent }}</span> / <span class="live-total">{{ report.campaign.total_recipients or 0 }}</span> ‚Ä¢ Pending: <span class="live-pending">{{ report.pending }}</span> ‚Ä¢ Failed: <span class="live-failed">{{ report.failed }}</span></div>
    </div>

    <!-- Key Metrics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary">{{ report.sent }}</h3>
                    <p class="card-text">Sent</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info">{{ report.unique_opens }}</h3>
                    <p class="card-text">Unique Opens ({{ report.unique_open_rate }})</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success">{{ report.unique_clicks }}</h3>
                    <p class="card-text">Unique Clicks ({{ report.unique_click_rate }})</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-danger">{{ report.failed }}</h3>
                    <p class="card-text">Failed</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Send Log (live) -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Recent Sends</h5>
        </div>
        <div class="table-responsive">
            <table id="send-log-table" class="table table-sm mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Recipient</th>
                        <th>Sender</th>
                        <th>Status</th>
                        <th>Time</th>
                        <th>Retries</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- rows populated via JS -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pending -->
    {% if report.pending > 0 %}
    <div class="alert alert-warning">
        <strong>‚è≥ Pending:</strong> {{ report.pending }} emails waiting for available SMTP account capacity
    </div>
    {% endif %}

    <!-- Top Links -->
    {% if report.top_links %}
    <div class="card mb-4">
        <div class="card-header">
            <h5>Top Performing Links</h5>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Link</th>
                        <th>Type</th>
                        <th>Clicks</th>
                    </tr>
                </thead>
                <tbody>
                    {% for link in report.top_links %}
                    <tr>
                        <td>
                            <code class="small">{{ link.link_text or link.url[:50] }}</code>
                        </td>
                        <td><span class="badge bg-secondary">{{ link.click_type }}</span></td>
                        <td><strong>{{ link.count }}</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Device Breakdown -->
    {% if report.device_stats %}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Opens by Device</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Device</th>
                                <th>Opens</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for device in report.device_stats %}
                            <tr>
                                <td>{{ device.device_type or 'Unknown' }}</td>
                                <td>{{ device.count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Click Type Breakdown -->
        {% if report.click_type_stats %}
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Clicks by Type</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Type</th>
                                <th>Count</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for click_type in report.click_type_stats %}
                            <tr>
                                <td>{{ click_type.click_type }}</td>
                                <td>{{ click_type.count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Actions -->
    <div class="mb-4">
        <a href="{{ url_for('main.campaign_report_html', id=report.campaign.id) }}" class="btn btn-primary" download>
            üì• Download HTML Report
        </a>
        <a href="{{ url_for('main.analytics') }}" class="btn btn-secondary">Back to Analytics</a>
    </div>
</div>

<script src="https://cdn.socket.io/4/socket.io.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
    const container = document.getElementById('campaign-live');
    if(!container) return;
    const cid = container.dataset.cid;

    async function updateProgress(){
        try{
            const res = await fetch(`/api/campaign/${cid}/progress`);
            if(!res.ok) return;
            const j = await res.json();
            container.querySelector('.live-status').textContent = j.status || '';
            container.querySelector('.live-sent').textContent = j.sent;
            container.querySelector('.live-total').textContent = j.total;
            container.querySelector('.live-pending').textContent = j.pending;
            container.querySelector('.live-failed').textContent = j.failed;
        } catch(e){ console.warn('live update failed', e); }
    }

    async function loadLogs(){
        try{
            const res = await fetch(`/api/campaign/${cid}/logs`);
            if(!res.ok) return;
            const rows = await res.json();
            const tbody = document.querySelector('#send-log-table tbody');
            tbody.innerHTML = '';
            rows.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${r.recipient}</td><td>${r.sender || ''}</td><td>${r.status}</td><td>${r.timestamp || ''}</td><td>${r.retry_count || 0}</td>`;
                tbody.appendChild(tr);
            });
        } catch(e){ console.warn('load logs failed', e); }
    }

    // initial load
    updateProgress();
    loadLogs();

    // poll progress every 5s
    setInterval(updateProgress, 5000);

    // socket realtime
    try{
        const socket = io();
        socket.on('send_update', function(data){
            if(String(data.campaign_id) !== String(cid)) return;
            // prepend new row
            const tbody = document.querySelector('#send-log-table tbody');
            const tr = document.createElement('tr');
            const ts = data.timestamp || '';
            tr.innerHTML = `<td>${data.recipient}</td><td>${data.sender || ''}</td><td>${data.status}</td><td>${ts}</td><td>0</td>`;
            if(tbody.firstChild) tbody.insertBefore(tr, tbody.firstChild); else tbody.appendChild(tr);

            // update summary counters
            const sentEl = container.querySelector('.live-sent');
            const pendingEl = container.querySelector('.live-pending');
            const failedEl = container.querySelector('.live-failed');
            let sent = parseInt(sentEl.textContent || '0',10);
            let pending = parseInt(pendingEl.textContent || '0',10);
            let failed = parseInt(failedEl.textContent || '0',10);
            if(data.status === 'sent'){
                sent += 1; if(pending>0) pending -= 1;
            } else if(data.status === 'failed'){
                failed += 1; if(pending>0) pending -= 1;
            } else if(data.status === 'pending'){
                pending += 1;
            }
            sentEl.textContent = sent;
            pendingEl.textContent = pending;
            failedEl.textContent = failed;
        });
    }catch(e){ console.warn('socket.io not available', e); }
});
</script>
</div>
{% endblock %}
